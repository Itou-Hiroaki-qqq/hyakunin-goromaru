# 百人一首 -ゴロでマル覚え- (hyakunin-goromaru)

百人一首を語呂合わせで学習できるWebアプリです。

## 技術スタック

- **フロント**: Next.js 15 (App Router) + TypeScript + Tailwind CSS + DaisyUI
- **認証**: Supabase Auth
- **句データ**: Neon (PostgreSQL) + `@neondatabase/serverless` + 自前 API `/api/poems`
- **音声**: Howler.js（Neon の `kami_audio_url` / `shimo_audio_url` / `kami_goro_audio_url` / `shimo_goro_audio_url` を再生）

## セットアップ（ステップバイステップ）

### 1. 依存関係

```bash
npm install
```

### 2. 環境変数

プロジェクト直下に `.env.local` を作成し、以下を設定してください。

```env
# Neon PostgreSQL（句データ用）
DATABASE_URL=postgresql://ユーザー:パスワード@ホスト/DB名?sslmode=require

# Supabase（認証用）
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

- **DATABASE_URL**: Neon のダッシュボードで「Connection string」をコピーして貼り付け。
- **Supabase**: [Supabase](https://supabase.com) でプロジェクト作成後、Settings → API の「Project URL」と「anon public」キーをコピー。

### 3. Neon のテーブル

句データは `poems` テーブルに格納されている想定です。  
別プロジェクト（hyakunin-tts）の `import-to-neon.js` で CSV から投入済みであれば、そのまま利用できます。

**クリア状態保存用テーブルの作成**

学習リストの星マーク機能を使用するには、`user_test_clears` テーブルを作成してください。

1. Neon のダッシュボードで SQL Editor を開く
2. 以下の SQL を実行：

```sql
-- sql/create_user_test_clears.sql の内容をコピー＆ペースト
```

または、プロジェクト直下の `sql/create_user_test_clears.sql` ファイルの内容を Neon の SQL Editor で実行してください。

### 4. 開発サーバー

```bash
npm run dev
```

ブラウザで [http://localhost:3000](http://localhost:3000) を開きます。

### 5. 音声再生と CORS（R2 の場合）

音声ファイルを Cloudflare R2 で配信している場合、ブラウザから直接 R2 の URL を読みに行くため **CORS 設定**が必要です。

- **症状**: 「始める」を押すとひらがなは出るがその先に進まない／コンソールに `Access-Control-Allow-Origin` の CORS エラーが出る。
- **対処**: R2 バケットに CORS ポリシーを設定する。

**Cloudflare ダッシュボードでの手順（概要）**

1. Cloudflare ダッシュボード → **R2** → 対象のバケットを選択
2. **設定** → **CORS ポリシー** で以下を追加（開発時は `*` でも可）

例（開発・本番どちらからも読む場合）:

```json
[
  {
    "AllowedOrigins": ["http://localhost:3000", "https://あなたの本番ドメイン"],
    "AllowedMethods": ["GET", "HEAD"],
    "AllowedHeaders": ["*"],
    "MaxAgeSeconds": 3600
  }
]
```

- 開発だけなら `"AllowedOrigins": ["http://localhost:3000"]` のみでよいです。
- 設定後、音声が読み込めるようになると、学習の自動再生が最後まで進み、音声も鳴ります。

CORS を設定するまででも **学習の流れは止まらない**ようにしてあります（音声読み込み失敗または約8秒で次へ進みます）。

## 実装済み

1. **プロジェクト立ち上げ** - Next.js App Router + TypeScript + Tailwind + DaisyUI
2. **API** - `GET /api/poems`（Neon serverless 使用。`?from=1&to=4` や `?from=1&to=100` で範囲指定可）
3. **新規登録** - `/register`（Supabase Auth）
4. **ログイン** - `/login`
5. **トップ** - `/`（タイトル・学習スタート・復習ボタン、フッターのみ）
   - **復習**ボタンは、学習リストや間違えやすい問題のテストで1問でも間違えているときのみ有効（リンク）。それ以外は無効表示。
6. **学習リスト** - `/learn`（1～100首を4首単位で25ブロック）
   - 各ブロック（例：1～4首、5～8首、…、97～100首）をクリックで展開。
   - 展開時は縦並びで「学習」「4首でテスト」を表示。クリア済みのブロックには★マーク表示。
   - **前回も入れて8首でテスト**: 5～8首・13～16首・21～24首…など、偶数番目のブロックに表示。前4首＋当該4首の計8首でテスト。
   - **ここまでのまとめテスト**: 16首学習以降の偶数ブロックに表示。1首～当該ブロック末までのまとめテスト。
   - **100首ぜんぶテスト**: リスト最下部。全100首から出題。
   - **間違えやすい問題**: リスト下部。上の句がまぎらわしい問題・下の句がまぎらわしい問題への入口。
7. **学習** - `/learn/[range]/study`（`[range]` は `1-4`, `5-8`, …, `97-100`）
   - **学習**: 漢字表示 → 「始める」で自動再生。上の句ひらがな1文字ずつ＋上の句音声 → 下の句ひらがな1文字ずつ＋下の句音声 → 語呂部分を赤＋語呂音声 → 語呂の意味＋語呂音声 → 「練習へ」
   - **練習**: 上の句（ひらがな）を縦書き札で表示、上の句音声の自動再生、語呂を赤表示。4択は正解（下の句ひらがな）＋全100首からランダム3首。〇×表示・「学習に戻る」「次の首へ」あり。
8. **4首／8首／まとめテスト** - `/learn/[range]/test`
   - `[range]` は `1-4`, `5-8`, …, `97-100`（4首）、`1-8`, `9-16`, …（8首）、`1-16`, `1-24`, …（まとめテスト）。
   - 上の句＋音声。選択肢は正解＋当該範囲内の他首から3つ。縦書き札・畳風背景・〇×。
   - **語呂解説＆音声**: 選択肢を選ぶ（正解・不正解どちらでも）と語呂の意味を表示し、上の句語呂→下の句語呂の順で音声再生。**正解時のみ**語呂部分に赤文字＆下線（上の句→下の句の順で表示）。
   - 最後の1問を正解したあとは「次へ」ボタンを押すと結果画面へ。語呂音声・赤表示を確認してから遷移可能。
   - 結果画面で正解数表示。一発全問正解でクリア扱い（★マーク用に API で保存）。
9. **100首ぜんぶテスト** - `/learn/all/test`
   - 全100首から出題。4首テストと同様に語呂解説・語呂音声・正解時のみ赤表示。一発全問正解でクリア（★）。
10. **間違えやすい問題** - `/learn/tricky`
    - **上の句がまぎらわしい** - `/learn/tricky/kami`：その1～その25などセット単位。下の句を見て上の句を選ぶ。各セットページで「まとめてテスト」あり。
    - **下の句がまぎらわしい** - `/learn/tricky/shimo`：同様に上の句を見て下の句を選ぶ。まとめてテストあり。
    - 語呂解説・語呂音声・正解時のみ赤表示（上の句語呂→下の句語呂の順）。「次の問題へ」で音声停止。
11. **復習ページ** - `/review`
    - 学習リストの4首／8首／まとめ／100首テスト、および間違えやすい問題のまとめてテストで間違えた問題が一覧で出題される。
    - 語呂解説・語呂音声・正解時のみ赤表示。解いたあと「復習からはずす」でリストから削除。「次へ」で復習から外さず次の復習問題へ。
    - 復習する問題がなくなるとトップの復習ボタンは無効になる。

## メタ

- `title`: 百人一首 -ゴロでマル覚え-
- `robots`: noindex, nofollow 設定済み

## 素材について（任意）

- **畳背景**: 現在は CSS の `bg-tatami` で簡易表現しています。いらすとや・O-DAN・Pixabay 等の画像に差し替える場合は `src/components/QuizCard.tsx` や `globals.css` の `.bg-tatami` を変更してください。
- **〇・×**: 現在は文字（〇/×）で表示しています。画像にしたい場合は `src/components/QuizCard.tsx` の `ChoiceCard` 内の `result === "correct"` / `"wrong"` の部分を `<img>` に差し替えてください。

## 次のステップ（続きの指示で実装予定）

- 特になし（復習ページ・間違えやすい問題・語呂解説付きテストなど主要機能は実装済み）
